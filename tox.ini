# Tox configuration for dt-rag
# Run local CI/CD tests without Docker or GitHub Actions
# Usage: tox (run all), tox -e py313 (specific env), tox -p auto (parallel)

[tox]
envlist = py313,lint,coverage
isolated_build = True
skip_missing_interpreters = True

[testenv]
description = Run unit and integration tests with pytest
deps =
    # Core dependencies
    -r requirements.txt
    # Test dependencies
    pytest>=7.4.0
    pytest-asyncio>=0.21.0
    pytest-cov>=4.1.0
    pytest-xdist>=3.3.0
    pytest-timeout>=2.1.0
setenv =
    # Test database (SQLite for speed)
    DATABASE_URL = sqlite+aiosqlite:///./dt_rag_test.db
    # Disable langfuse in tests
    LANGFUSE_ENABLED = false
    # Python optimizations
    PYTHONDONTWRITEBYTECODE = 1
    PYTHONPATH = {toxinidir}
commands =
    # Parallel test execution with coverage
    pytest -n auto --cov=apps --cov-report=term-missing --cov-report=html -v --tb=short {posargs}

[testenv:py313]
basepython = python3.13
description = Test with Python 3.13 (GitHub Actions environment)

[testenv:py314]
basepython = python3.14
description = Test with Python 3.14 (local development)

[testenv:quick]
description = Quick smoke test (unit tests only, no coverage)
commands =
    pytest tests/unit -x --tb=short -q --maxfail=5 {posargs}

[testenv:lint]
description = Run linting checks (ruff)
skip_install = True
deps =
    ruff>=0.1.0
commands =
    ruff check apps/ tests/ --output-format=github

[testenv:format]
description = Auto-format code with ruff
skip_install = True
deps =
    ruff>=0.1.0
commands =
    ruff check apps/ tests/ --fix
    ruff format apps/ tests/

[testenv:coverage]
description = Generate detailed coverage report
commands =
    pytest --cov=apps --cov-report=html --cov-report=term-missing --cov-fail-under=85

[testenv:integration]
description = Run integration tests only
commands =
    pytest tests/integration -v --tb=short {posargs}

[testenv:e2e]
description = Run end-to-end tests
setenv =
    {[testenv]setenv}
    DATABASE_URL = postgresql+asyncpg://postgres:postgres@localhost:5432/dt_rag_test
commands =
    pytest tests/e2e -v --tb=short {posargs}

# GitHub Actions integration
[gh-actions]
python =
    3.13: py313, lint, coverage
    3.14: py314

[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
markers =
    unit: Unit tests (fast, no external dependencies)
    integration: Integration tests (require database/cache connections)
    e2e: End-to-end tests (full system workflow tests)
    slow: Slow running tests (> 1 second)
