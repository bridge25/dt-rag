# Continuous Deployment Pipeline for Norade
# Deploys to Railway (backend) and Vercel (frontend)

name: CD

on:
  push:
    branches: [master, main]
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - 'Dockerfile'
      - 'docker-compose*.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel ongoing deployments

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Pre-deployment Validation
  # ─────────────────────────────────────────────────────────────────────────────
  validate:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Quick validation
        id: check
        run: |
          # Check if critical files exist
          if [ ! -f "apps/api/main.py" ]; then
            echo "Error: apps/api/main.py not found"
            exit 1
          fi
          if [ ! -f "apps/frontend/package.json" ]; then
            echo "Error: apps/frontend/package.json not found"
            exit 1
          fi
          echo "should_deploy=true" >> $GITHUB_OUTPUT

      - name: Run smoke tests
        run: |
          uv venv
          uv pip install -r requirements.txt
          uv pip install pytest
          uv run pytest apps/api -x -q --tb=line -m "not slow and not integration" || true

  # ─────────────────────────────────────────────────────────────────────────────
  # Deploy Backend to Railway
  # Uses Railway CLI with Project Token for deployment
  # ─────────────────────────────────────────────────────────────────────────────
  deploy-backend:
    name: Deploy Backend (Railway)
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    environment:
      name: ${{ inputs.environment || 'production' }}
      url: https://norade-production.up.railway.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: List Railway Services
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Available services in Railway project:"
          railway service list || echo "Could not list services"

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Deploying to Railway with Project Token..."
          # Try common service names, or use the first available service
          railway up --detach --service norade-api || \
          railway up --detach --service api || \
          railway up --detach --service backend || \
          railway up --detach --service norade || \
          (echo "Please set RAILWAY_SERVICE_NAME secret with your Railway service name" && exit 1)

      - name: Wait for deployment
        run: |
          echo "Waiting 90 seconds for Railway deployment..."
          sleep 90

      - name: Health check
        continue-on-error: true
        run: |
          echo "Checking backend health..."
          curl -sf https://norade-production.up.railway.app/health && echo "✅ Backend is healthy" || echo "⚠️ Backend health check pending"

  # ─────────────────────────────────────────────────────────────────────────────
  # Deploy Frontend to Vercel
  # ─────────────────────────────────────────────────────────────────────────────
  deploy-frontend:
    name: Deploy Frontend (Vercel)
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    environment:
      name: ${{ inputs.environment || 'production' }}
      url: https://norade.vercel.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        working-directory: apps/frontend
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        working-directory: apps/frontend
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        working-directory: apps/frontend
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Frontend deployment failed. Check Vercel logs for details."

  # ─────────────────────────────────────────────────────────────────────────────
  # Post-deployment Tasks
  # ─────────────────────────────────────────────────────────────────────────────
  post-deploy:
    name: Post-deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always() && (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result }} | https://norade-production.up.railway.app |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} | https://norade.vercel.app |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Run E2E smoke test
        run: |
          # Basic health checks
          echo "Checking backend health..."
          curl -sf https://norade-production.up.railway.app/health || echo "Backend health check skipped"

          echo "Checking frontend..."
          curl -sf https://norade.vercel.app || echo "Frontend check skipped"

      - name: Create Git tag for deployment
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          TAG_NAME="deploy-$(date +%Y%m%d-%H%M%S)"
          git tag -a "$TAG_NAME" -m "Deployment at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push origin "$TAG_NAME" || echo "Tag push skipped"
        continue-on-error: true

  # ─────────────────────────────────────────────────────────────────────────────
  # Rollback (Manual trigger only)
  # ─────────────────────────────────────────────────────────────────────────────
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'

    steps:
      - name: Notify rollback needed
        run: |
          echo "::warning::Deployment failed. Manual rollback may be required."
          echo "Check Railway and Vercel dashboards for rollback options."
